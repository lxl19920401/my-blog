name: Auto Deploy # 当前工作流程的名称
on: 
  push: 
    branches: 
      - main # 只要push到main分支，就会触发该工作流程
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 使用别人封装好的的action，用于clone该仓库的源码到工作流中
      - name: Checkout
        uses: actions/checkout@v3

      # 在工作流中安装node环境（必需，这样才能在后续工作流程中运行 npm install 等指令，否则会报错）
      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18 # 更新到更现代的Node版本
          
      # 安装依赖并构建前端应用
      - name: Build Frontend
        run: |
          cd client # 进入前端侧的工程目录
          npm install # 安装依赖
          npm run build # 打包前端代码到生产环境

      # 部署前端静态文件到Nginx服务器
      - name: Deploy Frontend to Nginx
        uses: cross-the-world/scp-pipeline@master
        with:
          host: ${{ secrets.MY_HOST }} # 服务器IP
          user: ${{ secrets.MY_USER }} # 服务器用户名
          pass: ${{ secrets.MY_PASS }} # 服务器密码
          connect_timeout: 10s
          local: './client/dist/*' # 源路径（构建后的前端文件）
          remote: /var/www/html/${{ secrets.CUSTOM_DOMAIN }} # 部署到自定义域名目录

      # 同步server目录下的后端代码到服务器（目标路径：/home/nginx/myBlogServer）
      - name: Deploy Backend
        uses: cross-the-world/scp-pipeline@master
        with:
          host: ${{ secrets.MY_HOST }} # 服务器IP
          user: ${{ secrets.MY_USER }} # 服务器用户名
          pass: ${{ secrets.MY_PASS }} # 服务器密码
          connect_timeout: 10s
          local: './server/*' # 源路径（工作流）
          remote: /home/nginx/myBlogServer # 目标路径（服务器）
        
      # 配置Nginx虚拟主机（自定义域名）
      - name: Configure Nginx for Custom Domain
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.MY_HOST }} # 服务器IP
          username: ${{ secrets.MY_USER }} # 服务器用户名
          password: ${{ secrets.MY_PASS }} # 服务器密码
          script: |
            # 创建Nginx配置文件
            cat > /etc/nginx/sites-available/${{ secrets.CUSTOM_DOMAIN }} << EOF
            server {
                listen 80;
                server_name ${{ secrets.CUSTOM_DOMAIN }};
                
                location / {
                    root /var/www/html/${{ secrets.CUSTOM_DOMAIN }};
                    index index.html index.htm;
                    try_files \$uri \$uri/ /index.html;
                }
                
                location /api {
                    proxy_pass http://localhost:3000; # 后端API服务地址
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
            
            # 创建软链接并启用站点
            ln -sf /etc/nginx/sites-available/${{ secrets.CUSTOM_DOMAIN }} /etc/nginx/sites-enabled/
            
            # 测试Nginx配置
            nginx -t
            
            # 重启Nginx服务
            systemctl reload nginx

      # 在服务器端执行相关指令启动后端服务
      - name: Start Backend Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.MY_HOST }} # 服务器IP
          username: ${{ secrets.MY_USER }} # 服务器用户名
          password: ${{ secrets.MY_PASS }} # 服务器密码
          script: |
            cd /home/nginx/myBlogServer # 进入服务器中的后端工程所在的目录
            export NODE_HOME=/root/.nvm/versions/node/v18.17.0  # 更新Node版本路径
            export PATH=$PATH:$NODE_HOME/bin 
            npm install # 安装项目依赖
            pm2 delete myBlogServer || true # 删除旧的进程（如果存在）
            pm2 start --name myBlogServer npm -- run server # 启动新的进程
            pm2 save
            pm2 startup